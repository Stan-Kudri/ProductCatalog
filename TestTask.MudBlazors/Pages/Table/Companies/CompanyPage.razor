@page "/company"

@using TestTask.Core.Models
@using TestTask.Core.Models.Companies
@using TestTask.Core.Models.Page
@using TestTask.MudBlazors.Model
@using TestTask.MudBlazors.Extension
@using Page = TestTask.Core.Models.Page.Page;
@inject CompanyService CompanyService

<PageTitle>Company</PageTitle>
<MudText Typo="Typo.h5" Align="Align.Center" GutterBottom="true">Company</MudText>
<MudTable Items="@companies" Hover="true" SortLabel="Sort By" Elevation="0" @bind-SelectedItems="selectedItems" MultiSelection="true">
    <ToolBarContent>
        <MudSelect T="string?" Label="Select type sort" Required="true" @bind-Value="@valueTypeSort">
            @foreach (string? typeSort in typeSortField.Items)
            {
                <MudSelectItem Value="@typeSort" />
            }
        </MudSelect>
        <MudSpacer />
        <MudSelect T="string?" Label="Select column" Required="true" Disabled="@isNotDisableFilter" @bind-Value="@sortField.SortField">
            @foreach (string? column in sortField.Items)
            {
                <MudSelectItem Value="@column"/>
            }
        </MudSelect>
        <MudSpacer />
        <MudTextField T="string" ValueChanged="@(s=>OnSearch(s))" Placeholder="Search" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        <MudSpacer />
        <MudTooltip Text="Use Filter" Placement="Placement.Top">
            <MudIconButton Icon="@Icons.Material.Filled.Done" Color="Color.Tertiary" OnClick="@UseFilter"/>
        </MudTooltip> 
        <MudTooltip Text="Remove Filter" Placement="Placement.Top">
            <MudIconButton Icon="@Icons.Material.Filled.Restore" Color="Color.Warning" OnClick="@ClearFilter"/>
        </MudTooltip>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Id</MudTh>
        <MudTh>Name</MudTh>
        <MudTh>Country</MudTh>
        <MudTh>DateCreation</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Id">@context.Id</MudTd>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Country">@context.Country</MudTd>
        <MudTd DataLabel="DataCreation">@context.DateCreation.ToString("d")</MudTd>
    </RowTemplate>
    <PagerContent>
            <MudTablePager PageSizeOptions="pageModel.Items" />
    </PagerContent>
    <FooterContent>
        <MudTd colspan="4">Select All</MudTd>
    </FooterContent>
</MudTable>
<ToolBarContent>
    <MudTooltip Text="Add" Placement="Placement.Bottom">
            <MudFab Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.Add" Size="Size.Medium" />
    </MudTooltip>
    <MudTooltip Text="Edit" Placement="Placement.Bottom">
            <MudFab Color="Color.Warning" StartIcon="@Icons.Material.Filled.Edit" Size="Size.Medium" />
    </MudTooltip>
    <MudTooltip Text="Remove" Placement="Placement.Bottom">
            <MudFab Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Remove" Size="Size.Medium" />
    </MudTooltip>
</ToolBarContent>


    @code {

    private IEnumerable<Company>? companies;
    private HashSet<Company> selectedItems = new HashSet<Company>();

    private int totalItems;
    private string? searchString = null;
    private string valueTypeSort { get; set; } = TypeSortField.NoSorting;
    private bool isNotDisableFilter => valueTypeSort == TypeSortField.NoSorting || valueTypeSort == null ? true : false;

    private SortCompanies sortField = new SortCompanies();
    private TypeSortField typeSortField = new TypeSortField();
    private PageModel pageModel = new PageModel();

    protected override void OnInitialized() => LoadData();

    private void LoadData()
    {
        IQueryable<Company> queriable = CompanyService.GetQueryableAll();
        queriable = GetSearchName(queriable);
        queriable = sortField.Apply(queriable, typeSortField.IsAscending);
        var result = queriable.GetPagedList<Company>(pageModel);
        companies = result.Items;
    }

    private void OnSearch(string text)
    {
        searchString = text;
        LoadData();
    }

    private void UseFilter()
    {
        typeSortField.SetSort(valueTypeSort);
        LoadData();
    }

    private void ClearFilter()
    {
        valueTypeSort = TypeSortField.NoSorting;
        typeSortField.SetSort(valueTypeSort);
        LoadData();
    }

    private IQueryable<Company> GetSearchName(IQueryable<Company> items)
            => string.IsNullOrEmpty(searchString)
            ? items
            : items.Where(e => e.Name.Contains(searchString) 
                            || e.Country.Contains(searchString) 
                            || e.DateCreation.ToString().Contains(searchString));
}
